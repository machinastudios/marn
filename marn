#!/bin/bash
# Marn - Yarn for Maven
# CLI tool that reads scripts from pom.xml and executes them

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get script directory (where marn script is located)
# If called via symlink, resolve to actual script location
if [ -L "$0" ]; then
    # Get the directory of the actual script (not the symlink)
    SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi

# Get current working directory (where user is running commands from)
CURRENT_DIR=$(pwd)
# POM_FILE should be in the current working directory, not in script directory
POM_FILE="${CURRENT_DIR}/pom.xml"

# Check if pom.xml exists
if [ ! -f "$POM_FILE" ]; then
    # If pom.xml doesn't exist, check if we're being called with init or help
    if [ "$1" != "init" ] && [ "$1" != "--help" ] && [ "$1" != "-h" ] && [ "$1" != "help" ] && [ -z "$1" ]; then
        echo -e "${RED}Error: pom.xml not found${NC}"
        echo "Please run 'marn' commands from a Maven project directory, or"
        echo "run 'marn init' to install marn globally."
        exit 1
    fi
fi

# Extract script from pom.xml (reads from properties with script. prefix)
get_script() {
    local script_name=$1
    if [ ! -f "$POM_FILE" ]; then
        echo ""
        return
    fi
    grep -A 1 "<script\.${script_name}>" "$POM_FILE" 2>/dev/null | tail -1 | sed 's/^[[:space:]]*//' | sed 's/<[^>]*>//g' || echo ""
}

# Get property from pom.xml
get_property() {
    local prop_name=$1
    if [ ! -f "$POM_FILE" ]; then
        echo ""
        return
    fi
    # Try multiple patterns to find the property
    local value=$(grep -A 1 "<${prop_name}>" "$POM_FILE" 2>/dev/null | tail -1 | sed 's/^[[:space:]]*//' | sed 's/<[^>]*>//g' || echo "")
    # If empty, try without the closing tag on same line
    if [ -z "$value" ]; then
        value=$(grep "<${prop_name}>" "$POM_FILE" 2>/dev/null | sed "s/.*<${prop_name}>\(.*\)<\/${prop_name}>.*/\1/" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' || echo "")
    fi
    echo "$value"
}

# Get local dependencies from pom.xml
get_local_dependencies() {
    local deps=""
    if [ ! -f "$POM_FILE" ]; then
        echo ""
        return
    fi
    local configured_deps=$(get_property "watch.localDeps")
    if [ ! -z "$configured_deps" ]; then
        deps="$configured_deps"
    fi
    
    local temp_deps_file=$(mktemp)
    
    # Find all artifact IDs in dependencies that have SNAPSHOT version
    awk '
    BEGIN { in_dep=0; artifact=""; has_snapshot=0 }
    /<dependency>/ { in_dep=1; artifact=""; has_snapshot=0 }
    /<\/dependency>/ { 
        if (in_dep && has_snapshot && artifact != "") {
            print artifact
        }
        in_dep=0; artifact=""; has_snapshot=0 
    }
    in_dep && /<artifactId>/ {
        gsub(/.*<artifactId>/, "")
        gsub(/<\/artifactId>.*/, "")
        gsub(/^[ \t]+|[ \t]+$/, "")
        artifact=$0
    }
    in_dep && /SNAPSHOT/ { has_snapshot=1 }
    ' "$POM_FILE" > "$temp_deps_file"
    
    # Check each artifact ID for local directories
    while IFS= read -r artifact_id; do
        if [ -n "$artifact_id" ]; then
            # Try common locations for local dependencies
            # 1. Sibling directory with artifact name
            if [ -d "${CURRENT_DIR}/../${artifact_id}" ] && [ -f "${CURRENT_DIR}/../${artifact_id}/pom.xml" ]; then
                deps="${deps} ${CURRENT_DIR}/../${artifact_id}"
            fi
        fi
    done < "$temp_deps_file"
    
    rm -f "$temp_deps_file"
    
    # Remove duplicates and empty entries
    echo "$deps" | tr ' ' '\n' | grep -v '^$' | sort -u | tr '\n' ' '
}

# List all available scripts
list_scripts() {
    if [ ! -f "$POM_FILE" ]; then
        return
    fi
    echo -e "${BLUE}Available scripts:${NC}"
    grep -E "<script\.[^>]+>" "$POM_FILE" 2>/dev/null | sed 's/.*<script\.\([^>]*\)>.*/\1/' | while read script; do
        echo -e "  ${GREEN}${script}${NC}"
    done
}

# Show help
show_help() {
    echo -e "${BLUE}Marn - Yarn for Maven${NC}"
    echo ""
    echo "Usage: marn <command>"
    echo ""
    echo "Commands:"
    echo "  init       Install marn globally (creates symlink in /usr/local/bin)"
    echo "  install    Install dependencies (mvn dependency:resolve)"
    echo "  link       Link current project to local Maven repository (~/.m2)"
    echo "  install-deps Install dependencies (mvn dependency:resolve)"
    echo "  build      Build the project (mvn clean compile)"
    echo "  test       Run tests (mvn test)"
    echo "  package    Package the project (mvn package)"
    echo "  run        Build and run the JAR"
    echo "  clean      Clean the project (mvn clean)"
    echo "  watch      Watch for changes and rebuild"
    echo "  <script>   Run custom script from pom.xml"
    echo ""
    echo "Custom scripts are defined in pom.xml under <properties>:"
    echo "  <script.myScript>mvn compile</script.myScript>"
    echo ""
    if [ -f "$POM_FILE" ]; then
        list_scripts
    fi
}

# Install marn globally (system-wide) - gets the currently running script and links it
init_marn() {
    local target_dir="/usr/local/bin"
    local target="${target_dir}/marn"
    
    # Get the absolute path of the currently running script
    local current_script=""
    if [ -L "$0" ]; then
        # If called via symlink, get the actual script path
        current_script=$(readlink -f "$0")
    else
        # If called directly, use the script path
        current_script="$0"
        # Make it absolute
        if [[ "$current_script" != /* ]]; then
            current_script="$(cd "$(dirname "$current_script")" && pwd)/$(basename "$current_script")"
        fi
    fi
    
    echo -e "${BLUE}Installing marn globally...${NC}"
    echo -e "${YELLOW}Source: ${current_script}${NC}"
    echo -e "${YELLOW}Target: ${target}${NC}"
    echo ""
    
    # Check if we have write access to /usr/local/bin
    if [ -w "$target_dir" ]; then
        # We have write access
        if [ -L "$target" ]; then
            echo -e "${YELLOW}Removing existing symlink: ${target}${NC}"
            rm "$target"
        elif [ -f "$target" ]; then
            echo -e "${YELLOW}Removing existing file: ${target}${NC}"
            rm "$target"
        fi
        
        ln -sf "$current_script" "$target"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Marn installed to ${target}${NC}"
            echo ""
            echo "You can now use 'marn' from anywhere in your system!"
            echo ""
            echo "Test it with: marn --help"
            return 0
        else
            echo -e "${RED}Failed to create symlink${NC}"
            exit 1
        fi
    else
        # Need sudo
        echo -e "${YELLOW}Installing to ${target_dir} requires sudo permissions${NC}"
        echo -e "${YELLOW}Please enter your password:${NC}"
        
        if [ -L "$target" ] || [ -f "$target" ]; then
            sudo rm -f "$target"
        fi
        
        sudo ln -sf "$current_script" "$target"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Marn installed to ${target}${NC}"
            echo ""
            echo "You can now use 'marn' from anywhere in your system!"
            echo ""
            echo "Test it with: marn --help"
            return 0
        else
            echo -e "${RED}Installation failed${NC}"
            exit 1
        fi
    fi
}

# Build local dependencies (DRY function)
build_local_dependencies() {
    local skip_tests=$1
    skip_tests="${skip_tests:-true}"
    
    LOCAL_DEPS=$(get_local_dependencies)
    if [ -n "$LOCAL_DEPS" ]; then
        echo -e "${YELLOW}Building local dependencies first...${NC}"
        for dep_path in $LOCAL_DEPS; do
            # Resolve relative paths
            if [[ "$dep_path" != /* ]]; then
                dep_path="${CURRENT_DIR}/${dep_path}"
            fi
            
            # Check if it's a valid Maven project
            if [ -f "${dep_path}/pom.xml" ]; then
                echo -e "${BLUE}Building dependency: ${dep_path}${NC}"
                cd "$dep_path"
                if [ "$skip_tests" = "true" ]; then
                    mvn clean install -DskipTests > /dev/null 2>&1
                else
                    mvn clean install > /dev/null 2>&1
                fi
                if [ $? -ne 0 ]; then
                    echo -e "${RED}Failed to build dependency: ${dep_path}${NC}"
                    cd "$CURRENT_DIR"
                    return 1
                fi
                echo -e "${GREEN}✓ Dependency built: ${dep_path}${NC}"
            fi
        done
    cd "$CURRENT_DIR"
        echo ""
    fi
    return 0
}

# Link current project to local Maven repository (.m2)
link_project() {
    # Check if pom.xml exists
    if [ ! -f "$POM_FILE" ]; then
        echo -e "${RED}Error: pom.xml not found${NC}"
        echo "Please run 'marn link' from a Maven project directory."
        exit 1
    fi
    
    echo -e "${BLUE}Linking project to local Maven repository...${NC}"
    echo ""
    
    cd "$CURRENT_DIR"
    
    # Run mvn install to add to .m2
    echo -e "${GREEN}Installing project to ~/.m2/repository...${NC}"
    mvn clean install -DskipTests
    
    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}✓ Project linked to local Maven repository!${NC}"
        echo ""
        echo "Other projects can now use this as a dependency."
    else
        echo -e "${RED}✗ Failed to link project${NC}"
        exit 1
    fi
}


# Execute a script
execute_script() {
    local script_name=$1
    local script_content=$(get_script "$script_name")
    
    if [ -z "$script_content" ]; then
        echo -e "${RED}Error: Script '${script_name}' not found in pom.xml${NC}"
        echo ""
        list_scripts
        exit 1
    fi
    
    echo -e "${YELLOW}Executing script: ${script_name}${NC}"
    echo -e "${BLUE}Command: ${script_content}${NC}"
    echo ""
    
    # Change to project directory
    cd "$CURRENT_DIR"
    
    # Execute the script
    bash -c "$script_content"
}

# Function to run Maven build command
run_maven_build() {
    local command=$1
    local skip_tests=$2
    
    if [ "$skip_tests" = "true" ]; then
        mvn $command -DskipTests 2>&1 | tee /tmp/mvn-watch-output.log | grep -E "(ERROR|BUILD|Compiling|SUCCESS|FAILURE)" || true
    else
        mvn $command 2>&1 | tee /tmp/mvn-watch-output.log | grep -E "(ERROR|BUILD|Compiling|SUCCESS|FAILURE)" || true
    fi
    return ${PIPESTATUS[0]}
}

# Function to run post command
run_post_command() {
    local post_command=$1
    if [ -n "$post_command" ]; then
        echo -e "${YELLOW}Running post command: ${post_command}${NC}"
        cd "$CURRENT_DIR"
        bash -c "$post_command" || true
    fi
}

# Function to build and check result
build_and_check() {
    local command_to_run=$1
    local skip_tests=$2
    local post_command=$3
    local success_message=$4
    local failure_message=$5

    run_maven_build "$command_to_run" "$skip_tests"
    local build_exit_code=$?

    if [ $build_exit_code -eq 0 ]; then
        echo -e "${GREEN}✓ ${success_message}${NC}"
        run_post_command "$post_command"
    else
        echo -e "${RED}✗ ${failure_message}${NC}"
        echo -e "${YELLOW}Check full output in /tmp/mvn-watch-output.log${NC}"
        return 1
    fi
    return 0
}

# Watch mode - integrated into marn
watch_mode() {
    # Check if pom.xml exists
    if [ ! -f "$POM_FILE" ]; then
        echo -e "${RED}Error: pom.xml not found${NC}"
        echo "Please run 'marn watch' from a Maven project directory."
        exit 1
    fi

    # Check if inotifywait is available
    if ! command -v inotifywait &> /dev/null; then
        echo -e "${RED}Error: inotifywait not found. Install inotify-tools:${NC}"
        echo "  sudo apt-get install inotify-tools"
        exit 1
    fi

    # Get watch configuration from pom.xml or use defaults
    WATCH_DIRS=$(get_property "watch.dirs")
    WATCH_DIRS="${WATCH_DIRS:-src/main/java src/main/resources}"
    
    BUILD_COMMAND=$(get_property "watch.buildCommand")
    BUILD_COMMAND="${BUILD_COMMAND:-compile}" # Default to compile, not mvn compile
    
    SKIP_TESTS=$(get_property "watch.skipTests")
    SKIP_TESTS="${SKIP_TESTS:-true}"
    
    DEBOUNCE_TIME=$(get_property "watch.debounceTime")
    DEBOUNCE_TIME="${DEBOUNCE_TIME:-2}"
    
    POST_COMMAND=$(get_property "watch.postCommand")
    
    # Get local dependencies to watch
    LOCAL_DEPS=$(get_local_dependencies)
    LOCAL_DEP_PATHS=""
    if [ -n "$LOCAL_DEPS" ]; then
        for dep_path in $LOCAL_DEPS; do
            # Resolve relative paths
            if [[ "$dep_path" != /* ]]; then
                dep_path="${CURRENT_DIR}/${dep_path}"
            fi
            
            # Check if it's a valid Maven project
            if [ -f "${dep_path}/pom.xml" ]; then
                # Add source directories to watch
                if [ -d "${dep_path}/src/main/java" ]; then
                    LOCAL_DEP_PATHS="${LOCAL_DEP_PATHS} ${dep_path}/src/main/java"
                fi
                if [ -d "${dep_path}/src/main/resources" ]; then
                    LOCAL_DEP_PATHS="${LOCAL_DEP_PATHS} ${dep_path}/src/main/resources"
                fi
            fi
        done
    fi

    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║     Maven Watch Build (Generic)      ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Configuration:${NC}"
    echo -e "  ${GREEN}Watching:${NC} ${WATCH_DIRS}"
    if [ -n "$LOCAL_DEP_PATHS" ]; then
        echo -e "  ${GREEN}Local Dependencies:${NC}"
        for dep_path in $LOCAL_DEPS; do
            if [[ "$dep_path" != /* ]]; then
                dep_path="${CURRENT_DIR}/${dep_path}"
            fi
            if [ -f "${dep_path}/pom.xml" ]; then
                echo -e "    - ${dep_path}"
            fi
        done
    fi
    echo -e "  ${GREEN}Command:${NC} ${BUILD_COMMAND}"
    echo -e "  ${GREEN}Skip Tests:${NC} ${SKIP_TESTS}"
    echo -e "  ${GREEN}Debounce:${NC} ${DEBOUNCE_TIME}s"
    if [ -n "$POST_COMMAND" ]; then
        echo -e "  ${GREEN}Post Command:${NC} ${POST_COMMAND}"
    fi
    echo ""
    echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
    echo ""

    cd "$CURRENT_DIR"

    # Build local dependencies first
    if ! build_local_dependencies "$SKIP_TESTS"; then
        exit 1
    fi

    # Initial build
    echo -e "${GREEN}Running initial build...${NC}"
    build_and_check "$BUILD_COMMAND" "$SKIP_TESTS" "$POST_COMMAND" "Initial build complete!" "Initial build failed!"
    if [ $? -ne 0 ]; then
        exit 1
    fi
    echo ""

    # Watch for changes
    LAST_BUILD=0
    LAST_DEP_BUILD=0

    while true; do
        # Wait for file changes (watch both project and local dependencies)
        ALL_WATCH_DIRS="${WATCH_DIRS}${LOCAL_DEP_PATHS}"
        inotifywait -r -e modify,create,delete,move \
            --format '%w%f %e' \
            $ALL_WATCH_DIRS 2>/dev/null | while read FILE EVENT; do
            
            # Check if change is in a local dependency
            IS_LOCAL_DEP=false
            CHANGED_DEP_PATH=""
            for dep_path in $LOCAL_DEPS; do
                if [[ "$dep_path" != /* ]]; then
                    dep_path="${CURRENT_DIR}/${dep_path}"
                fi
                if [[ "$FILE" == "${dep_path}"* ]]; then
                    IS_LOCAL_DEP=true
                    CHANGED_DEP_PATH="$dep_path"
                    break
                fi
            done
            
            # Debounce: only build if enough time has passed
            CURRENT_TIME=$(date +%s)
            
            if [ "$IS_LOCAL_DEP" = "true" ]; then
                # For local dependencies, check debounce separately
                TIME_SINCE_LAST_DEP_BUILD=$((CURRENT_TIME - LAST_DEP_BUILD))
                
                if [ $TIME_SINCE_LAST_DEP_BUILD -ge $DEBOUNCE_TIME ]; then
                    echo -e "\n${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
                    echo -e "${YELLOW}Change detected in local dependency:${NC} ${FILE}"
                    echo -e "${YELLOW}Event:${NC} ${EVENT}"
                    echo -e "${GREEN}Linking dependency and rebuilding...${NC}"
                    
                    # Link the local dependency first (install to .m2)
                    cd "$CHANGED_DEP_PATH"
                    echo -e "${BLUE}Linking dependency: ${CHANGED_DEP_PATH}${NC}"
                    
                    # Build and link the dependency (mvn clean install)
                    if [ "$SKIP_TESTS" = "true" ]; then
                        mvn clean install -DskipTests > /dev/null 2>&1
                    else
                        mvn clean install > /dev/null 2>&1
                    fi
                    
                    if [ $? -ne 0 ]; then
                        echo -e "${RED}Failed to link dependency: ${CHANGED_DEP_PATH}${NC}"
                        cd "$CURRENT_DIR"
                        continue
                    fi
                    
                    echo -e "${GREEN}✓ Dependency linked: ${CHANGED_DEP_PATH}${NC}"
                    
                    # Return to project directory and rebuild
                    cd "$CURRENT_DIR"
                    build_and_check "$BUILD_COMMAND" "$SKIP_TESTS" "$POST_COMMAND" "Dependency linked and build successful!" "Build failed!"
                    
                    LAST_DEP_BUILD=$(date +%s)
                    LAST_BUILD=$(date +%s)  # Also update main build time
                    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
                    echo ""
                fi
            else
                # For project files, use normal debounce
                TIME_SINCE_LAST_BUILD=$((CURRENT_TIME - LAST_BUILD))
                
                if [ $TIME_SINCE_LAST_BUILD -ge $DEBOUNCE_TIME ]; then
                    echo -e "\n${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
                    echo -e "${YELLOW}Change detected:${NC} ${FILE}"
                    echo -e "${YELLOW}Event:${NC} ${EVENT}"
                    echo -e "${GREEN}Rebuilding...${NC}"
                    
                    build_and_check "$BUILD_COMMAND" "$SKIP_TESTS" "$POST_COMMAND" "Build successful!" "Build failed!"
                    
                    LAST_BUILD=$(date +%s)
                    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
                    echo ""
                fi
            fi
        done
    done
}

# Main command handler
case "$1" in
    init)
        init_marn
        ;;
    install)
        echo -e "${GREEN}Installing dependencies...${NC}"
        cd "$CURRENT_DIR"
        mvn dependency:resolve
        ;;
    link)
        link_project
        ;;
    install-deps)
        echo -e "${GREEN}Installing dependencies...${NC}"
        cd "$CURRENT_DIR"
        mvn dependency:resolve
        ;;
    build)
        echo -e "${GREEN}Building project...${NC}"
        cd "$CURRENT_DIR"
        
        # Build local dependencies first
        if ! build_local_dependencies "true"; then
                        exit 1
        fi
        
        mvn clean compile
        ;;
    test)
        echo -e "${GREEN}Running tests...${NC}"
        cd "$CURRENT_DIR"
        
        # Build local dependencies first
        if ! build_local_dependencies "true"; then
            exit 1
        fi
        
        mvn test
        ;;
    package)
        echo -e "${GREEN}Packaging project...${NC}"
        cd "$CURRENT_DIR"
        mvn clean package
        ;;
    run)
        echo -e "${GREEN}Building and running project...${NC}"
        cd "$CURRENT_DIR"
        
        # Build local dependencies first
        if ! build_local_dependencies "true"; then
            exit 1
        fi
        
        # Get project info from pom.xml (generic)
        # Change to current directory first to ensure we're in the project directory
        cd "$CURRENT_DIR"
        ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null || echo "")
        MAIN_CLASS=$(grep -A 1 "<mainClass>" "$POM_FILE" 2>/dev/null | tail -1 | sed 's/^[[:space:]]*//' | sed 's/<[^>]*>//g' || echo "")
        
        # Kill any existing Java processes running the JAR to avoid SQLite lock (generic)
        if [ -n "$MAIN_CLASS" ]; then
            pkill -f "java.*${MAIN_CLASS}" 2>/dev/null || true
        fi
        if [ -n "$ARTIFACT_ID" ]; then
            pkill -f "java.*${ARTIFACT_ID}.*jar" 2>/dev/null || true
        fi
        # Also try to kill by any JAR in target directory
        OLD_JAR=$(ls target/*.jar 2>/dev/null | head -n 1)
        if [ -n "$OLD_JAR" ]; then
            JAR_BASENAME=$(basename "$OLD_JAR")
            pkill -f "java.*${JAR_BASENAME}" 2>/dev/null || true
        fi
        # Wait for processes to terminate
        sleep 1
        
        # Ensure data directory exists (if it's referenced in the project)
        mkdir -p data 2>/dev/null || true
        
        mvn clean package -DskipTests
        
        JAR_NAME=$(ls target/*.jar 2>/dev/null | head -n 1)
        
        if [ -z "$JAR_NAME" ]; then
            echo -e "${RED}Error: No JAR file found in target/ directory${NC}"
            exit 1
        fi
        
        echo -e "${GREEN}Running: ${JAR_NAME}${NC}"
        echo ""
        
        shift
        java -jar "$JAR_NAME" "$@"
        ;;
    clean)
        echo -e "${GREEN}Cleaning project...${NC}"
        cd "$CURRENT_DIR"
        mvn clean
        ;;
    watch)
        watch_mode
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        # Check if it's a custom script
        execute_script "$1"
        ;;
esac
